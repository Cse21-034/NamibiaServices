// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  // Hashed password for credentials provider
  password      String?   @map("password_hash")
  emailVerified DateTime? @map("email_verified")
  image         String?
  role          UserRole  @default(USER)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Profile fields for all users
  phone         String?
  bio           String?
  location      String?
  website       String?
  
  // User-specific fields (for regular users)
  membershipType UserMembershipType? @default(BASIC)
  
  // Business-specific fields (if user is a business owner)
  businesses    Business[]
  
  // Relations
  accounts      Account[]
  sessions      Session[]
  reviews       Review[]
  favorites     Favorite[]
  notifications Notification[]
  bookings      Booking[]
  reviewLikes   ReviewLike[]  // ADDED THIS MISSING RELATION

  @@map("users")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Business {
  id              String        @id @default(cuid())
  ownerId         String        @map("owner_id")
  parentBusinessId String?      @map("parent_business_id")
  isBranch        Boolean       @default(false) @map("is_branch")
  branchName      String?       @map("branch_name")
  
  name            String
  slug            String        @unique
  description     String?
  categoryId      String        @map("category_id")
  subCategoryId   String?       @map("subcategory_id")
  email           String
  phone           String
  website         String?
  logo            String?
  coverImage      String?       @map("cover_image")
  
  // Location
  address         String?
  city            String
  region          String?
  country         String        @default("Namibia")
  latitude        Float?
  longitude       Float?
  
  // Business details
  establishedYear Int?          @map("established_year")
  employees       String?
  pricingRange    PricingRange? @map("pricing_range") @default(MODERATE)
  
  // Services
  services        String[]
  
  // Social media
  facebook        String?
  twitter         String?
  instagram       String?
  linkedin        String?
  
  // Status
  status          BusinessStatus @default(PENDING)
  verified        Boolean       @default(false)
  featured        Boolean       @default(false)
  
  // Stats
  viewCount       Int           @default(0) @map("view_count")
  reviewCount     Int           @default(0) @map("review_count")
  averageRating   Float?        @map("average_rating")
  
  // Timestamps
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  publishedAt     DateTime?     @map("published_at")
  
  // Relations
  owner           User          @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  parentBusiness  Business?     @relation("BusinessBranches", fields: [parentBusinessId], references: [id], onDelete: Cascade)
  branches        Business[]    @relation("BusinessBranches")
  category        Category      @relation("BusinessToCategory", fields: [categoryId], references: [id])
  subcategory     Category?     @relation("BusinessToSubcategory", fields: [subCategoryId], references: [id])
  reviews         Review[]
  photos          BusinessPhoto[]
  businessHours   BusinessHours[]
  favorites       Favorite[]
  bookings        Booking[]
  listings        Listing[]
  promotions      Promotion[]
  
  @@map("businesses")
}

model Listing {
  id          String   @id @default(cuid())
  title       String
  description String
  businessId  String   @map("business_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@map("listings")
}

model Promotion {
  id          String   @id @default(cuid())
  title       String
  description String
  discount    Int
  image       String?  // Promotion-specific image (optional, defaults to business image)
  expiryDate  DateTime @map("expiry_date")
  businessId  String   @map("business_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@map("promotions")
}

model BusinessHours {
  id          String   @id @default(cuid())
  businessId  String   @map("business_id")
  dayOfWeek   Int      @map("day_of_week")
  openTime    String?  @map("open_time")
  closeTime   String?  @map("close_time")
  isClosed    Boolean  @default(false) @map("is_closed")
  
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  @@unique([businessId, dayOfWeek])
  @@map("business_hours")
}

model BusinessPhoto {
  id          String   @id @default(cuid())
  businessId  String   @map("business_id")
  url         String
  caption     String?
  isPrimary   Boolean  @default(false) @map("is_primary")
  orderIndex  Int      @default(0) @map("order_index")
  createdAt   DateTime @default(now()) @map("created_at")
  
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  @@map("business_photos")
}

model Category {
  id          String     @id @default(cuid())
  name        String
  slug        String     @unique
  description String?
  icon        String?
  color       String?
  parentId    String?    @map("parent_id")
  orderIndex  Int        @default(0) @map("order_index")
  
  parent      Category?  @relation("CategoryToCategory", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryToCategory")
  businesses  Business[] @relation("BusinessToCategory")
  subBusinesses Business[] @relation("BusinessToSubcategory")
  
  @@map("categories")
}

model Review {
  id          String   @id @default(cuid())
  businessId  String   @map("business_id")
  userId      String   @map("user_id")
  rating      Int
  title       String?
  comment     String?
  images      String[]
  likes       Int      @default(0)
  helpful     Int      @default(0)
  reply       String?
  status      ReviewStatus @default(APPROVED) // Changed from PENDING to APPROVED for simplicity
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  reviewLikes ReviewLike[]
  
  @@unique([businessId, userId])
  @@map("reviews")
}

model ReviewLike {
  id       String @id @default(cuid())
  reviewId String @map("review_id")
  userId   String @map("user_id")
  
  review   Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([reviewId, userId])
  @@map("review_likes")
}

model Favorite {
  id         String   @id @default(cuid())
  userId     String   @map("user_id")
  businessId String   @map("business_id")
  createdAt  DateTime @default(now()) @map("created_at")
  
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  @@unique([userId, businessId])
  @@map("favorites")
}

model Booking {
  id          String        @id @default(cuid())
  userId      String        @map("user_id")
  businessId  String        @map("business_id")
  serviceType String        @map("service_type")
  date        DateTime
  time        String
  duration    Int?
  notes       String?
  status      BookingStatus @default(PENDING)
  customerName  String  @map("customer_name")
  customerEmail String  @map("customer_email")
  customerPhone String  @map("customer_phone")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  business      Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  @@map("bookings")
}

model Notification {
  id        String           @id @default(cuid())
  userId    String           @map("user_id")
  type      NotificationType
  title     String
  message   String
  data      Json?
  read      Boolean          @default(false)
  createdAt DateTime         @default(now()) @map("created_at")
  
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("notifications")
}

// Enums
enum UserRole {
  USER
  BUSINESS
  ADMIN
}

enum UserMembershipType {
  BASIC
  PREMIUM
}

enum BusinessStatus {
  DRAFT
  PENDING
  PUBLISHED
  SUSPENDED
}

enum PricingRange {
  BUDGET
  MODERATE
  PREMIUM
  LUXURY
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum NotificationType {
  REVIEW
  BOOKING
  SYSTEM
  PROMOTIONAL
}